{% extends "layout.html" %}
{% block title %}dashboard{% endblock %}

{% block content %}
<h1>dashboard</h1>

<div class="row">
    <div class="col-8">
        <div class="card mb-3">
            <div class="card-header">
                Temperature
            </div>
            <div class="card-body">
                <canvas id="temperature-chart" width="" height=""></canvas>
            </div>
        </div>
    </div>
    <div class="col-4">
        <div class="card mb-3">
            <div class="card-header">
                Weather {{ (weather['data']['$']|int/60)|int }}:00
            </div>
            <div class="card-body">
                MetOffice {{ weather['location'] }}
            </div>
            <ul class="list-group list-group-flush">
                {% for p in weather['keys'] %}
                    {% if weather['data'][p['name']] %}
	            <li class="list-group-item py-1">
                        {{ p['$'] }}
                        {% if p['name'] == 'W' %}
                            {{ weather['types'][weather['data'][p['name']]] }}

                            {% if weather['icons'][weather['data'][p['name']]] %}
                    <ul class="weather-icon-list">
                                {% for icon in weather['icons'][weather['data'][p['name']]] %}
                        <li class="weather-icon-item {{ icon }}"></li>
                                {% endfor %}
                    </ul>
                            {% endif %}
                        {% else %}
                            {{ weather['data'][p['name']] }}
                        {% endif %}
                        {{ p['units'] }}
                </li>
                    {% endif %}
	            {% endfor %}
            </ul>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-12">
        <div class="card mb-3">
            <div class="card-body bg-light">
                <div class="card-text">Rooms</div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    {% for room in rooms %}
    <div class="col-3">
        <div class="card mb-3">
            <div class="card-header">{{ room['name'] }}</div>
            <div class="card-body">
                {% if room_temps[room['id']] %}
                {% set last_temp = room_temps[room['id']]|last %}
                <p class="card-text">{{ last_temp['data_val'] }}c</p>
                {% else %}
                <p class="card-text">No temperature data</p>
                {% endif %}
            </div>
            <ul class="list-group list-group-flush">
	            {% for light_id in room_lights[room['id']] %}
	            <li class="list-group-item">
                    {{ room_lights[room['id']][light_id]['name'] }}
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="switch_{{ light_id }}" onchange="switchLight({{ light_id }})" {% if room_lights[room['id']][light_id]['state']['on'] %}checked="checked"{% endif %} />
                        <label class="custom-control-label" for="switch_{{ light_id }}">Switch</label>
                    </div>
                </li>
	            {% endfor %}
            </ul>
        </div>
    </div>
    {% endfor %}
</div>
<div class="row">
    <div class="col-12">
        <div class="card mb-3">
            <div class="card-body bg-light">
                <div class="card-text">System</div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-3">
        <div class="card mb-3">
            <div class="card-header">
                Database
            </div>
            <div class="card-body">
                {{ database['file_name'] }} <br/>
                {{ database['file_size'] / 1024 }} KB<br/>
                From: {{ database['minmax']['min'] }}<br/>
                To: {{ database['minmax']['max'] }}<br/>
            </div>
        </div>
    </div>
    <div class="col-3">
        <div class="card mb-3">
            <div class="card-header">
                Disk
            </div>
            <div class="card-body">
               {{ (system['root_data'].total / 1024 / 1024 / 1024)|round(2) }} GB total<br/>
               {{ (system['root_data'].free / 1024 / 1024 / 1024)|round(2) }} GB free<br/>
               {{ (system['root_data'].used / 1024 / 1024 / 1024)|round(2) }} GB used<br/>
            </div>
        </div>
    </div>
    <div class="col-3">
        <div class="card mb-3">
            <div class="card-header">
                Disk
            </div>
            <div class="card-body">
                <canvas id="disk-chart" width="" height=""></canvas>
            </div>
        </div>
    </div>
    <div class="col-3">
        <div class="card mb-3">
            <div class="card-header">
                Memory
            </div>
            <div class="card-body">
               {{ (system['mem_data'].total / 1024 / 1024 / 1024)|round(2) }} GB total<br/>
               {{ (system['mem_data'].available / 1024 / 1024 / 1024)|round(2) }} GB available<br/>
               {{ (system['mem_data'].used / 1024 / 1024 / 1024)|round(2) }} GB used<br/>
            </div>
        </div>
    </div>
    <div class="col-3">
        <div class="card mb-3">
            <div class="card-header">
                Memory
            </div>
            <div class="card-body">
                <canvas id="memory-chart" width="" height=""></canvas>
            </div>
        </div>
    </div>
    <div class="col-3">
        <div class="card mb-3">
            <div class="card-header">
                CPU
            </div>
            <div class="card-body">
                {{ system['cpu_perc'] }}%<br/>
                {{ system['cpu_temp'] }}c
            </div>
        </div>
    </div>
</div>

<script>
var colours = [
	'red',
	'orange',
	'yellow',
	'green',
	'blue',
	'indigo',
	'violet'
];
var colour_choice = 0;
function get_colour(){
	return colours[colour_choice++];
}

var d_ctx = document.getElementById('disk-chart').getContext('2d');
var d_chart = new Chart(d_ctx, {
    type: 'pie',
    data: {
        datasets: [{
            data: [
                {{ system['root_data'].used / system['root_data'].total }},
                {{ system['root_data'].free / system['root_data'].total }}
            ],
            backgroundColor: [
                'red',
                'green'
            ],
            label: '/'
        }],
        labels: [
            'Used',
            'Free'
        ]
    },
    options: {
        responsive: true
    }
});

var m_ctx = document.getElementById('memory-chart').getContext('2d');
var m_chart = new Chart(m_ctx, {
    type: 'pie',
    data: {
        datasets: [{
            data: [
                {{ system['mem_data'].used / system['mem_data'].total }},
                {{ system['mem_data'].available / system['mem_data'].total }}
            ],
            backgroundColor: [
                'red',
                'green'
            ],
            label: '/'
        }],
        labels: [
            'Used',
            'Free'
        ]
    },
    options: {
        responsive: true
    }
});

var tc_ctx = document.getElementById('temperature-chart').getContext('2d');
var tc_chart = new Chart(tc_ctx, {
    type: 'line',
    data: {
        datasets: [
			{% for room in rooms %}
				{% if room_temps[room['id']] %}
		    {
			    label: '{{ room['name'] }}',
            	data: [
				{% for room_temp in room_temps[room['id']] %}
			        {
                        t: {{ room_temp['timestamp']*1000 }},
                        y: {{ room_temp['data_val'] }}
                    },
				{% endfor %}
		        ],
			    fill: false,
			    borderColor: get_colour(),
        	},
				{% endif %}
			{% endfor %}
	    ]
    },
    options: {
        scales: {
            xAxes: [{
                type: 'time',
                distribution: 'series',
                time: {
                    unit: 'minute',
                    displayFormats: {
                        minute: 'HH:mm',
                        second: 'HH:mm:ss',
                    },
                    tooltipFormat: 'YYYY-MM-DD HH:mm:ss',
                },
                ticks: {
                    source: 'auto',
                    autoSkip: true,
                },
            }]
        }
    }
});
</script>

{% endblock %}
